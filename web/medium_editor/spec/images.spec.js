describe("Images addon",function(){beforeEach(function(){$("body").append('<div id="fixtures"><div class="editable"></div></div>'),this.$el=$(".editable"),this.editor=new MediumEditor(this.$el.get(0)),this.$el.mediumInsert({editor:this.editor}),this.addon=this.$el.data("plugin_mediumInsertImages"),jasmine.clock().install()}),afterEach(function(){$("#fixtures").remove(),jasmine.clock().uninstall()}),it("creates preview image before upload",function(i){this.$el.find("p").click(),this.addon.uploadAdd(null,{autoUpload:!0,files:[new Blob([""],{type:"image/jpeg"})],submit:function(){expect(this.$el.find(".medium-insert-images").length).toEqual(1),expect(this.$el.find(".medium-insert-images img").length).toEqual(1),expect(this.$el.find(".medium-insert-images .medium-insert-images-progress").length).toEqual(1),expect(this.$el.find(".medium-insert-images img").attr("src").match(/^data:/).length).toEqual(1),i()}.bind(this),process:function(){return this},done:function(i){i()}})}),it("replaces preview by uploaded image",function(){var i=jasmine.createSpy("image");spyOn(this.addon,"getDOMImage").and.returnValue(i),this.$el.prepend('<div class="medium-insert-images medium-insert-active"><figure><img src="data:" alt=""></figure></div>'),this.addon.uploadDone(null,{context:this.$el.find("figure"),result:{files:[{url:"test.jpg"}]}}),i.onload(),expect(this.$el.find(".medium-insert-images img").attr("src")).toEqual("test.jpg")}),it("uploads without preview when it is set like this in options",function(i){this.addon.options.preview=!1,this.$el.find("p").click(),this.addon.uploadAdd(null,{autoUpload:!0,files:[new Blob([""],{type:"image/jpeg"})],submit:function(){expect(this.$el.find(".medium-insert-images").length).toEqual(1),expect(this.$el.find(".medium-insert-images progress").length).toEqual(1),expect(this.$el.find(".medium-insert-images img").length).toEqual(0),this.addon.uploadDone(null,{result:{files:[{url:"test.jpg"}]}}),expect(this.$el.find(".medium-insert-images img").attr("src")).toEqual("test.jpg"),i()}.bind(this),process:function(){return this},done:function(i){i()}})}),it("automatically adds grid when multiple images are in a set",function(i){this.addon.options.preview=!1,this.$el.prepend('<div class="medium-insert-images medium-insert-active"><figure></figure><figure></figure></div>'),this.addon.uploadAdd(null,{autoUpload:!0,files:[new Blob([""],{type:"image/jpeg"})],submit:function(){this.addon.uploadDone(null,{result:{files:[{url:"test.jpg"}]}}),expect(this.$el.find(".medium-insert-images").hasClass("medium-insert-images-grid")).toBe(!0),i()}.bind(this),process:function(){return this},done:function(i){i()}})}),it("doesn't add grid when not enough images are in a set",function(i){this.addon.options.preview=!1,this.$el.prepend('<div class="medium-insert-images medium-insert-active"><figure></figure></div>'),this.addon.uploadAdd(null,{autoUpload:!0,files:[new Blob([""],{type:"image/jpeg"})],submit:function(){this.addon.uploadDone(null,{result:{files:[{url:"test.jpg"}]}}),expect(this.$el.find(".medium-insert-images").hasClass("medium-insert-images-grid")).toBe(!1),i()}.bind(this),process:function(){return this},done:function(i){i()}})}),it("triggers input event on showImage",function(i){this.editor.subscribe("editableInput",function(){expect(!0).toBe(!0),i()}),this.addon.showImage(null,{submit:function(){}})}),it("truggers input event twice on showImage for preview",function(i){var e=0,t=jasmine.createSpy("image"),s=this.$el.prepend('<div class="medium-insert-images medium-insert-active"><figure><img src="data:" alt=""></figure></div>');spyOn(this.addon,"getDOMImage").and.returnValue(t),this.editor.subscribe("editableInput",function(){e++,2===e&&(expect(!0).toBe(!0),i())}),this.addon.showImage("http://image.co",{context:s}),t.onload()}),it("supports selecting image",function(){this.$el.find("p").addClass("medium-insert-images").append('<figure><img src="image1.jpg" alt=""></figure>'),this.$el.find("img").click(),jasmine.clock().tick(50),expect(this.$el.find("img").hasClass("medium-insert-image-active")).toBe(!0),expect($(".medium-insert-images-toolbar").length).toEqual(1),expect($(".medium-insert-images-toolbar2").length).toEqual(1),expect(this.$el.find("figcaption").length).toEqual(1)}),it("supports disabling captions",function(){$("#fixture").html('<div class="editable"><div class="medium-insert-images"><figure><img src="image1.jpg" alt=""></figure></div></div>'),this.$el=$(".editable"),this.$el.mediumInsert({addons:{images:{captions:!1}}}),this.$el.find("img").click(),jasmine.clock().tick(50),expect(this.$el.find("figcaption").length).toEqual(0)}),it("removes placeholder after clicking on caption",function(){this.$el.find("p").addClass("medium-insert-images").append('<figure><img src="image1.jpg" alt="" class="medium-insert-image-active"><figcaption class="medium-insert-caption-placeholder"></figcaption></figure>'),this.$el.find(".medium-insert-caption-placeholder").click(),jasmine.clock().tick(50),expect(this.$el.find("figcaption").hasClass("medium-insert-caption-placeholder")).toEqual(!1)}),it("supports unselecting image",function(){this.$el.find("p").addClass("medium-insert-images").append('<figure><img src="image1.jpg" alt="" class="medium-insert-image-active"><figcaption></figcaption></figure>'),this.$el.click(),expect(this.$el.find("img").hasClass("medium-insert-image-active")).toBe(!1),expect($(".medium-insert-images-toolbar").length).toEqual(0),expect($(".medium-insert-images-toolbar2").length).toEqual(0),expect(this.$el.find("figcaption").length).toEqual(0)}),it("supports removing image",function(){var i=$.Event("keydown");i.which=8,this.$el.find("p").addClass("medium-insert-images medium-insert-images-grid").append('<figure><img src="image1.jpg" alt=""></figure><figure><img src="image2.jpg" alt=""></figure><figure><img src="image3.jpg" alt=""></figure><figure><img src="image4.jpg" alt="" class="medium-insert-image-active"></figure>'),this.$el.trigger(i),expect(this.$el.find("img").length).toEqual(3),expect(this.$el.find(".medium-insert-images").hasClass("medium-insert-images-grid")).toBe(!0),this.$el.find("img").last().addClass("medium-insert-image-active"),this.$el.trigger(i),expect(this.$el.find("img").length).toEqual(2),this.$el.find("img").addClass("medium-insert-image-active"),this.$el.trigger(i),expect(this.$el.find(".medium-insert-images").length).toEqual(0),expect($(".medium-insert-images-toolbar").length).toEqual(0)}),it("triggers input event after removing image",function(i){var e=$.Event("keydown");this.editor.subscribe("editableInput",function(){expect(!0).toBe(!0),i()}),e.which=8,this.$el.find("p").addClass("medium-insert-images").append('<figure><img src="image1.jpg" alt=""></figure><figure><img src="image2.jpg" alt="" class="medium-insert-image-active"></figure>'),this.$el.trigger(e)}),it("supports deleting file",function(){var i=$.Event("keydown");i.which=8,this.$el.find("p").addClass("medium-insert-images").append('<figure><img src="image1.jpg" alt=""></figure><figure><img src="image2.jpg" alt="" class="medium-insert-image-active"></figure>'),spyOn(jQuery,"ajax"),this.$el.trigger(i),expect(jQuery.ajax.calls.count()).toEqual(1)}),it("support changing image style",function(){var i=this.$el.find("p").attr("class","medium-insert-images medium-insert-active medium-insert-images-left").append('<figure><img src="image1.jpg" alt=""></figure>');i.find("img").click(),jasmine.clock().tick(50),$(".medium-insert-images-toolbar .medium-editor-action").first().click(),expect(i.hasClass("medium-insert-images-wide")).toBe(!0),expect(i.hasClass("medium-insert-images-left")).toBe(!1)}),it("triggers input event after changing image style",function(i){var e=this.$el.find("p").attr("class","medium-insert-images medium-insert-active medium-insert-images-left").append('<figure><img src="image1.jpg" alt=""></figure>');this.editor.subscribe("editableInput",function(){expect(!0).toBe(!0),i()}),e.find("img").click(),jasmine.clock().tick(50),$(".medium-insert-images-toolbar .medium-editor-action").first().click()}),it("calls callback function after changing image style ",function(i){this.addon.options.styles.wide.added=function(){expect(!0).toBe(!0),i()},this.$el.find("p").addClass("medium-insert-images").append('<figure><img src="image1.jpg" alt=""></figure>'),placeCaret(this.$el.find("p").get(0),0),this.$el.find("img").click(),jasmine.clock().tick(50),$(".medium-insert-images-toolbar .medium-editor-action").first().click()}),it("calls callback function after clicking on image action ",function(i){this.addon.options.actions.remove.clicked=function(){expect(!0).toBe(!0),i()},this.$el.find("p").addClass("medium-insert-images").append('<figure><img src="image1.jpg" alt=""></figure>'),placeCaret(this.$el.find("p").get(0),0),this.$el.find("img").click(),jasmine.clock().tick(50),$(".medium-insert-images-toolbar2 .medium-editor-action").first().click()}),it("calls uploadCompleted callback",function(i){this.addon.options.uploadCompleted=function(){expect(!0).toBe(!0),i()},spyOn(this.addon,"showImage"),this.addon.uploadDone(null,{result:{files:[{url:"test.jpg"}]}})}),it("validatates file type on upload",function(i){spyOn(window,"alert").and.callFake(function(e){expect(e).toMatch(/^This file is not in a supported format/),i()}),this.$el.find("p").click(),this.addon.uploadAdd(null,{files:[{type:"application/json"}]})}),it("validates file size on upload",function(i){this.addon.options.fileUploadOptions.maxFileSize=1e3,spyOn(window,"alert").and.callFake(function(e){expect(e).toMatch(/^This file is too big/),i()}),this.$el.find("p").click(),this.addon.uploadAdd(null,{files:[{type:"image/jpeg",size:1001}]})})});