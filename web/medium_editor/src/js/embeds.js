!function(e,t,i,s){"use strict";function o(i,s){this.el=i,this.$el=e(i),this.templates=t.MediumInsert.Templates,this.core=this.$el.data("plugin_"+r),this.options=e.extend(!0,{},n,s),this._defaults=n,this._name=r,this.core.getEditor()&&(this.core.getEditor()._serializePreEmbeds=this.core.getEditor().serialize,this.core.getEditor().serialize=this.editorSerialize),this.init()}var r="mediumInsert",a="Embeds",n={label:'<span class="fa fa-youtube-play"></span>',placeholder:"Paste a YouTube, Vimeo, Facebook, Twitter or Instagram link and press Enter",oembedProxy:"http://medium.iframe.ly/api/oembed?iframe=1",captions:!0,captionPlaceholder:"Type caption (optional)",styles:{wide:{label:'<span class="fa fa-align-justify"></span>'},left:{label:'<span class="fa fa-align-left"></span>'},right:{label:'<span class="fa fa-align-right"></span>'}},actions:{remove:{label:'<span class="fa fa-times"></span>',clicked:function(){var t=e.Event("keydown");t.which=8,e(i).trigger(t)}}}};o.prototype.init=function(){var t=this.$el.find(".medium-insert-embeds");t.attr("contenteditable",!1),t.each(function(){0===e(this).find(".medium-insert-embeds-overlay").length&&e(this).append(e("<div />").addClass("medium-insert-embeds-overlay"))}),this.events(),this.backwardsCompatibility()},o.prototype.events=function(){e(i).on("click",e.proxy(this,"unselectEmbed")).on("keydown",e.proxy(this,"removeEmbed")).on("click",".medium-insert-embeds-toolbar .medium-editor-action",e.proxy(this,"toolbarAction")).on("click",".medium-insert-embeds-toolbar2 .medium-editor-action",e.proxy(this,"toolbar2Action")),this.$el.on("keyup click paste",e.proxy(this,"togglePlaceholder")).on("keydown",e.proxy(this,"processLink")).on("click",".medium-insert-embeds-overlay",e.proxy(this,"selectEmbed")).on("contextmenu",".medium-insert-embeds-placeholder",e.proxy(this,"fixRightClickOnPlaceholder"))},o.prototype.backwardsCompatibility=function(){var t=this;this.$el.find(".mediumInsert-embeds").removeClass("mediumInsert-embeds").addClass("medium-insert-embeds"),this.$el.find(".medium-insert-embeds").each(function(){0===e(this).find(".medium-insert-embed").length&&(e(this).after(t.templates["src/js/templates/embeds-wrapper.hbs"]({html:e(this).html()})),e(this).remove())})},o.prototype.editorSerialize=function(){var t=this._serializePreEmbeds();return e.each(t,function(i){var s=e("<div />").html(t[i].value);s.find(".medium-insert-embeds").removeAttr("contenteditable"),s.find(".medium-insert-embeds-overlay").remove(),t[i].value=s.html()}),t},o.prototype.add=function(){var e=this.$el.find(".medium-insert-active");e.html(this.templates["src/js/templates/core-empty-line.hbs"]().trim()),e.is("p")&&(e.replaceWith('<div class="medium-insert-active">'+e.html()+"</div>"),e=this.$el.find(".medium-insert-active"),this.core.moveCaret(e)),e.addClass("medium-insert-embeds medium-insert-embeds-input medium-insert-embeds-active"),this.togglePlaceholder({target:e.get(0)}),e.click(),this.core.hideButtons()},o.prototype.togglePlaceholder=function(i){var s,o,r,a=e(i.target),n=t.getSelection();n&&0!==n.rangeCount&&(s=n.getRangeAt(0),o=e(s.commonAncestorContainer),o.hasClass("medium-insert-embeds-active")?a=o:o.closest(".medium-insert-embeds-active").length&&(a=o.closest(".medium-insert-embeds-active")),a.hasClass("medium-insert-embeds-active")?(r=a.text().trim(),""===r&&a.hasClass("medium-insert-embeds-placeholder")===!1?a.addClass("medium-insert-embeds-placeholder").attr("data-placeholder",this.options.placeholder):""!==r&&a.hasClass("medium-insert-embeds-placeholder")&&a.removeClass("medium-insert-embeds-placeholder").removeAttr("data-placeholder")):this.$el.find(".medium-insert-embeds-active").remove())},o.prototype.fixRightClickOnPlaceholder=function(t){this.core.moveCaret(e(t.target))},o.prototype.processLink=function(e){var t,i=this.$el.find(".medium-insert-embeds-active");if(i.length)return t=i.text().trim(),""===t&&-1!==[8,46,13].indexOf(e.which)?void i.remove():void(13===e.which&&(e.preventDefault(),e.stopPropagation(),this.options.oembedProxy?this.oembed(t):this.parseUrl(t)))},o.prototype.oembed=function(i){var s=this;e.support.cors=!0,e.ajax({crossDomain:!0,cache:!1,url:this.options.oembedProxy,dataType:"json",data:{url:i},success:function(t){var i=t&&t.html;t&&!t.html&&"photo"===t.type&&t.url&&(i='<img src="'+t.url+'" alt="">'),e.proxy(s,"embed",i)()},error:function(o,r,a){var n=function(){try{return JSON.parse(o.responseText)}catch(e){}}();"undefined"!=typeof t.console?t.console.log(n&&n.error||o.status||a.message):t.alert("Error requesting media from "+s.options.oembedProxy+" to insert: "+a+" (response status: "+o.status+")"),e.proxy(s,"convertBadEmbed",i)()}})},o.prototype.parseUrl=function(t){var i;return new RegExp(["youtube","youtu.be","vimeo","instagram"].join("|")).test(t)?(i=t.replace(/\n?/g,"").replace(/^((http(s)?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\/(watch\?v=|v\/)?)([a-zA-Z0-9\-_]+)(.*)?$/,'<div class="video video-youtube"><iframe width="420" height="315" src="//www.youtube.com/embed/$7" frameborder="0" allowfullscreen></iframe></div>').replace(/^https?:\/\/vimeo\.com(\/.+)?\/([0-9]+)$/,'<div class="video video-vimeo"><iframe src="//player.vimeo.com/video/$2" width="500" height="281" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div>').replace(/^https?:\/\/instagram\.com\/p\/(.+)\/?$/,'<span class="instagram"><iframe src="//instagram.com/p/$1/embed/" width="612" height="710" frameborder="0" scrolling="no" allowtransparency="true"></iframe></span>'),void this.embed(/<("[^"]*"|'[^']*'|[^'">])*>/.test(i)?i:!1)):(e.proxy(this,"convertBadEmbed",t)(),!1)},o.prototype.embed=function(e){var t=this.$el.find(".medium-insert-embeds-active");return e?(t.after(this.templates["src/js/templates/embeds-wrapper.hbs"]({html:e})),t.remove(),this.core.triggerInput(),-1!==e.indexOf("facebook")&&"undefined"!=typeof FB&&setTimeout(function(){FB.XFBML.parse()},2e3),void 0):(alert("Incorrect URL format specified"),!1)},o.prototype.convertBadEmbed=function(t){var i,s,o,r=this.templates["src/js/templates/core-empty-line.hbs"]().trim();i=this.$el.find(".medium-insert-embeds-active"),o=e(r),i.before(o),i.remove(),o.html(t),s=e(r),o.after(s),this.core.triggerInput(),this.core.moveCaret(i)},o.prototype.selectEmbed=function(t){if(this.core.options.enabled){var i=e(t.target).hasClass("medium-insert-embeds")?e(t.target):e(t.target).closest(".medium-insert-embeds"),s=this;i.addClass("medium-insert-embeds-selected"),setTimeout(function(){s.addToolbar(),s.options.captions&&s.core.addCaption(i.find("figure"),s.options.captionPlaceholder)},50)}},o.prototype.unselectEmbed=function(t){var i=e(t.target).hasClass("medium-insert-embeds")?e(t.target):e(t.target).closest(".medium-insert-embeds"),s=this.$el.find(".medium-insert-embeds-selected");return i.hasClass("medium-insert-embeds-selected")?(s.not(i).removeClass("medium-insert-embeds-selected"),e(".medium-insert-embeds-toolbar, .medium-insert-embeds-toolbar2").remove(),this.core.removeCaptions(i.find("figcaption")),void((e(t.target).is(".medium-insert-caption-placeholder")||e(t.target).is("figcaption"))&&(i.removeClass("medium-insert-embeds-selected"),this.core.removeCaptionPlaceholder(i.find("figure"))))):(s.removeClass("medium-insert-embeds-selected"),e(".medium-insert-embeds-toolbar, .medium-insert-embeds-toolbar2").remove(),void(e(t.target).is(".medium-insert-caption-placeholder")?this.core.removeCaptionPlaceholder(i.find("figure")):e(t.target).is("figcaption")===!1&&this.core.removeCaptions()))},o.prototype.removeEmbed=function(t){var i,s;(8===t.which||46===t.which)&&(i=this.$el.find(".medium-insert-embeds-selected"),i.length&&(t.preventDefault(),e(".medium-insert-embeds-toolbar, .medium-insert-embeds-toolbar2").remove(),s=e(this.templates["src/js/templates/core-empty-line.hbs"]().trim()),i.before(s),i.remove(),this.core.hideAddons(),this.core.moveCaret(s),this.core.triggerInput()))},o.prototype.addToolbar=function(){var t,i,s,o=this.$el.find(".medium-insert-embeds-selected"),r=!1;if(0!==o.length){var a=this.core.getEditor(),n=a.options.elementsContainer||"body";e(n).append(this.templates["src/js/templates/embeds-toolbar.hbs"]({styles:this.options.styles,actions:this.options.actions}).trim()),t=e(".medium-insert-embeds-toolbar"),i=e(".medium-insert-embeds-toolbar2"),s=o.offset().top-t.height()-8-2-5,0>s&&(s=0),t.css({top:s,left:o.offset().left+o.width()/2-t.width()/2}).show(),i.css({top:o.offset().top+2,left:o.offset().left+o.width()-i.width()-4}).show(),t.find("button").each(function(){o.hasClass("medium-insert-embeds-"+e(this).data("action"))&&(e(this).addClass("medium-editor-button-active"),r=!0)}),r===!1&&t.find("button").first().addClass("medium-editor-button-active")}},o.prototype.toolbarAction=function(t){var i=e(t.target).is("button")?e(t.target):e(t.target).closest("button"),s=i.closest("li"),o=s.closest("ul"),r=o.find("li"),a=this.$el.find(".medium-insert-embeds-selected"),n=this;i.addClass("medium-editor-button-active"),s.siblings().find(".medium-editor-button-active").removeClass("medium-editor-button-active"),r.find("button").each(function(){var t="medium-insert-embeds-"+e(this).data("action");e(this).hasClass("medium-editor-button-active")?(a.addClass(t),n.options.styles[e(this).data("action")].added&&n.options.styles[e(this).data("action")].added(a)):(a.removeClass(t),n.options.styles[e(this).data("action")].removed&&n.options.styles[e(this).data("action")].removed(a))}),this.core.triggerInput()},o.prototype.toolbar2Action=function(t){var i=e(t.target).is("button")?e(t.target):e(t.target).closest("button"),s=this.options.actions[i.data("action")].clicked;s&&s(this.$el.find(".medium-insert-embeds-selected")),this.core.triggerInput()},e.fn[r+a]=function(t){return this.each(function(){e.data(this,"plugin_"+r+a)||e.data(this,"plugin_"+r+a,new o(this,t))})}}(jQuery,window,document);